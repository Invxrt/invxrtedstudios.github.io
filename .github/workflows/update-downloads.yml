name: Update Download Counts

on:
  schedule:
    # Run once per day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-downloads:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch download counts
        env:
          CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
          CURSEFORGE_AUTHOR_ID: ${{ vars.CURSEFORGE_AUTHOR_ID }}
        run: |
          set -euo pipefail
          CF_API_KEY="${CURSEFORGE_API_KEY:-}"
          CF_AUTHOR_ID="${CURSEFORGE_AUTHOR_ID:-103107110}"

          if [ -z "$CF_API_KEY" ]; then
            echo "Error: CURSEFORGE_API_KEY secret is not set."
            exit 1
          fi

          # Fetch CurseForge downloads via official API using the secret key
          CURSEFORGE_TOTAL=0
          CURSEFORGE_SUCCESS=false
          PER_PAGE=50
          INDEX=0
          declare -A PROJECT_CURSEFORGE

          while true; do
            RESPONSE=$(curl -s -w "\n%{http_code}" -H "Accept: application/json" -H "X-Api-Key: $CF_API_KEY" "https://api.curseforge.com/v1/mods/search?gameId=432&authorId=${CF_AUTHOR_ID}&pageSize=${PER_PAGE}&index=${INDEX}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Error: CurseForge API returned HTTP $HTTP_CODE at index $INDEX"
              exit 1
            fi

            PAGE_COUNT=$(echo "$BODY" | jq '.data | length' 2>/dev/null || echo "0")
            if [ "$PAGE_COUNT" -eq 0 ]; then
              break
            fi

            CURSEFORGE_SUCCESS=true

            while read -r SLUG DOWNLOADS; do
              PROJECT_CURSEFORGE[$SLUG]=$DOWNLOADS
              CURSEFORGE_TOTAL=$((CURSEFORGE_TOTAL + DOWNLOADS))
            done < <(echo "$BODY" | jq -r '.data[] | select(.slug != null and .downloadCount != null) | "\(.slug) \(.downloadCount)"')

            INDEX=$((INDEX + PER_PAGE))
          done

          if [ "$CURSEFORGE_SUCCESS" = false ]; then
            echo "Error: No CurseForge data was fetched; aborting update."
            exit 1
          fi

          echo "CurseForge total downloads (API): $CURSEFORGE_TOTAL"

          # No Modrinth for modpacks - CurseForge only
          MODRINTH_TOTAL=0

          # Calculate total (CurseForge only)
          TOTAL=$CURSEFORGE_TOTAL

          # Per-project download breakdown (used by homepage cards)
          declare -A PROJECT_MODRINTH
          PROJECT_SLUGS=("emc-to-the-sky" "emc-space-age" "subterra-tech")

          # Include any CurseForge projects discovered that aren't in the static list
          ALL_SLUGS=("${PROJECT_SLUGS[@]}" "${!PROJECT_CURSEFORGE[@]}")
          declare -A SEEN
          UNIQUE_SLUGS=()
          for SLUG in "${ALL_SLUGS[@]}"; do
            if [ -z "${SEEN[$SLUG]+x}" ]; then
              SEEN[$SLUG]=1
              UNIQUE_SLUGS+=("$SLUG")
            fi
          done

          # No Modrinth for modpacks - set all to 0
          for SLUG in "${UNIQUE_SLUGS[@]}"; do
            PROJECT_MODRINTH[$SLUG]=0
          done

          PROJECTS_JSON="{"
          for SLUG in "${UNIQUE_SLUGS[@]}"; do
            CF=${PROJECT_CURSEFORGE[$SLUG]:-0}
            MR=${PROJECT_MODRINTH[$SLUG]:-0}
            PROJECT_TOTAL=$((CF + MR))
            PROJECTS_JSON+="\"$SLUG\": {\"curseforge\": $CF, \"modrinth\": $MR, \"total\": $PROJECT_TOTAL},"
          done
          # Trim trailing comma
          PROJECTS_JSON="${PROJECTS_JSON%,}"
          PROJECTS_JSON="${PROJECTS_JSON}}"

          # Only update if CurseForge succeeded
          if [ "$CURSEFORGE_SUCCESS" = true ]; then
            # Create JSON file
            mkdir -p static/data
            cat > static/data/downloads.json << EOF
          {
            "modrinth": $MODRINTH_TOTAL,
            "curseforge": $CURSEFORGE_TOTAL,
            "total": $TOTAL,
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "projects": $PROJECTS_JSON
          }
          EOF
            echo "Total downloads: $TOTAL (Modrinth: $MODRINTH_TOTAL, CurseForge: $CURSEFORGE_TOTAL)"
          else
            echo "Error: CurseForge API failed, keeping existing data"
            exit 1
          fi

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add static/data/downloads.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update download counts" && git pull --rebase && git push)
